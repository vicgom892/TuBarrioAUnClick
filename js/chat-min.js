document.addEventListener("DOMContentLoaded",function(){let x=[];async function a(){try{if(window.businesses&&0<window.businesses.length)x=window.businesses,console.log(`✅ Chatbot usando ${x.length} negocios`);else{var e,a=localStorage.getItem("businesses_cache_v4");if(a)e=JSON.parse(a).data,x=e,console.log(`✅ Chatbot usando ${x.length} negocios desde caché`);else{var t=await fetch("data/negocios.json");if(!t.ok)throw new Error("Error al cargar negocios.json");x=await t.json(),console.log(`✅ Chatbot usando ${x.length} negocios desde JSON`)}}}catch(e){console.error("Error al cargar los negocios:",e),m("Lo siento, no pude cargar los datos de los negocios. Por favor, intenta de nuevo más tarde.","bot")}}const C={hola:"¡Hola! Bienvenido. ¿En qué puedo ayudarte?","buenos dias":"¡Buenos días! ¿Cómo puedo ayudarte hoy?","buenas tardes":"¡Buenas tardes! ¿En qué necesitas ayuda?","buenas noches":"¡Buenas noches! Estoy aquí para ayudarte.",gracias:"¡De nada! Estoy aquí para ayudarte.",adios:"¡Hasta luego! Que tengas un excelente día.",chao:"¡Hasta pronto! Cualquier duda, aquí estoy.",ayuda:"Puedo ayudarte con información sobre negocios, horarios, medios de pago, soporte y más. ¿Qué necesitas?",negocios:"Aquí tienes algunos negocios cercanos:",negocio:"Aquí tienes algunos negocios cercanos:",comercios:"Aquí tienes algunos negocios cercanos:",comercio:"Aquí tienes algunos negocios cercanos:",abiertos:"Te muestro los negocios que están abiertos ahora:",distancia:"La distancia a los negocios es:",horarios:"Los horarios de los negocios son:",horario:"Aquí tienes los horarios de los negocios:",soporte:"Para soporte inmediato, te redirigiré a WhatsApp.",whatsapp:"Para contactar con soporte, haz clic aquí: [Contactar por WhatsApp](https://wa.me/5491157194796)",wsp:"Para contactar con soporte, haz clic aquí: [Contactar por WhatsApp](https://wa.me/5491157194796)",mensaje:"Puedes enviarme un mensaje o usar el micrófono para hablar.","micrófono":"Haz clic en el micrófono para hablar conmigo.",voz:"Pueden hablarme usando el micrófono.",pagos:"Aceptamos efectivo, tarjetas de crédito y débito, transferencias y billeteras digitales.",pago:"Aceptamos efectivo, tarjetas de crédito y débito, transferencias y billeteras digitales.",tarjeta:"Aceptamos todas las tarjetas de crédito y débito.",efectivo:"Sí, aceptamos efectivo.",digital:"Aceptamos billeteras digitales como Mercado Pago, etc.","ubicación":"Nuestros negocios están ubicados en diferentes puntos de la ciudad. ¿Te interesa alguno en particular?",direccion:"¿Te refieres a la dirección de algún negocio específico?",telefono:"Puedes contactar a los negocios directamente por teléfono.",contacto:"Puedes contactar a los negocios por teléfono o WhatsApp.","información":"Estoy aquí para darte toda la información que necesitas.",info:"¿Qué información necesitas? Puedo ayudarte con negocios, horarios, pagos, etc."},t=document.getElementById("chatbotBtn"),o=document.getElementById("chatContainer"),r=document.getElementById("closeChat"),k=document.getElementById("chatBody"),i=document.getElementById("messageInput"),n=document.getElementById("sendBtn"),s=document.getElementById("voiceBtn"),c=document.getElementById("permissionModal");var e=document.getElementById("grantPermission"),l=document.getElementById("denyPermission");let d=!1,u=null,g=!1;function m(e,a){var t,o=document.createElement("div"),r=(o.className=`message message-${a} message-animation`,document.createElement("div")),e=(r.className="message-content",r.innerHTML=function(e){let a=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,a,t)=>{return`<a href="${t.trim().replace(/\s+/g,"")}" target="_blank" class="chat-link">${a}</a>`});return a=a.replace(/(https?:\/\/[^\s<]+[^\s<.,;:!?])/g,e=>{return`<a href="${e.trim().replace(/\s+/g,"")}" target="_blank" class="chat-link">${e}</a>`})}(e),document.createElement("div"));e.className="message-time",e.textContent=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"bot"===a&&((t=document.createElement("div")).className="ai-indicator",t.innerHTML=`
        <span class="ai-dot"></span>
        <span class="ai-dot"></span>
        <span class="ai-dot"></span>
        <small>AI Assistant</small>
      `,o.appendChild(t)),o.appendChild(r),o.appendChild(e),k.appendChild(o),"user"===a&&(t=document.querySelector(".quick-replies"))&&t.remove(),k.scrollTop=k.scrollHeight}function $(e,a){var t=P(e.hours),o=t?"status-open":"status-closed",r=t?"Abierto ahora":"Cerrado",t=t?"🟢":"🔴",i=document.createElement("div"),a=(i.className="business-card",i.style.animationDelay=.1*a+"s",T(e.category));return i.innerHTML=`
      <div class="business-name">
        ${a} ${e.name}
      </div>
      <div class="business-category">${e.category}</div>
      <div class="business-info">
        <i class="fas fa-clock"></i> ${e.hours}
      </div>
      <div class="business-info">
        <i class="fas fa-map-marker-alt"></i> Ubicación en el mapa
      </div>
      <div class="business-status ${o}">
        ${t} ${r}
      </div>
      <a href="${e.url}" target="_blank" class="business-link">
        <i class="fas fa-external-link-alt"></i> Ver detalles
      </a>
    `,i}function T(e){var a,t;for([a,t]of Object.entries({"Panadería":"🍞","Fábrica de Pastas":"🍝","Verdulería":"🥦","Fiambrería":"🧀",Kiosco:"🏪",Mascotas:"🐾","Barbería":"✂️","Ferretería":"🔧",Ropa:"👕",Servicios:"🛠️",Farmacia:"💊","Cafetería":"☕","Taller Mecánico":"🔧","Librería":"📚",Mates:"📚","Florería":"🌹"}))if(e.includes(a))return t;return"🏪"}function P(e){return"function"!=typeof window.isBusinessOpen||window.isBusinessOpen(e)}function p(e){e=e.toLowerCase();var a,t,o,r,i;for({regex:a,categoria:t}of[{regex:/supermercado|mercado|almacén|tienda/,categoria:"supermercado"},{regex:/farmacia|droguería/,categoria:"farmacia"},{regex:/panadería|pan/,categoria:"panaderia"},{regex:/ropa|prendas|vestimenta/,categoria:"ropa"},{regex:/restaurante|comida|resto/,categoria:"restaurante"},{regex:/verdulería|verdura|fruta/,categoria:"verduleria"},{regex:/fiambrería|fiambre/,categoria:"fiambreria"},{regex:/kiosco|kiosko/,categoria:"kiosco"},{regex:/mascotas|pet shop|veterinaria/,categoria:"mascotas"},{regex:/barbería|barberia|corte de pelo/,categoria:"barberia"},{regex:/ferretería|ferreteria|herramientas/,categoria:"ferreteria"},{regex:/servicios|plomero|electricista|cerrajero/,categoria:"servicios"},{regex:/farmacia|farmacéutica/,categoria:"farmacias"},{regex:/cafetería|café|cafetal/,categoria:"cafeterias"},{regex:/taller|automotor|gomería/,categoria:"talleres"},{regex:/librería|papelería/,categoria:"librerias"},{regex:/mates|mates/,categoria:"mates"},{regex:/florería|floristería|flores/,categoria:"florerias"}])if(a.test(e)){var n=t;const y={panaderia:"Panadería",pastas:"Fábrica de Pastas",verduleria:"Verdulería",fiambreria:"Fiambrería",kiosco:"Kiosco",mascotas:"Mascotas",barberia:"Barbería",ferreteria:"Ferretería",ropa:"Ropa",servicios:"Servicios",farmacias:"Farmacia",cafeterias:"Cafetería",talleres:"Taller Mecánico",librerias:"Librería",mates:"Mates",florerias:"Florería"}[n]||n;if(0===(n=x.filter(e=>e.category.includes(y))).length)return`No encontré ${y.toLowerCase()} en nuestra base de datos. ¿Te interesa otra categoría de negocio?`;(s=document.createElement("div")).className="business-category-header",s.innerHTML=`
      <h5 style="margin: 16px 0 8px 0; color: #128C7E; font-size: 14px; font-weight: 600;">
        ${T(y)} ${y} (${n.length})
      </h5>
    `,k.appendChild(s);let a=0;n.forEach(e=>{e=$(e,a++);k.appendChild(e)});var s=n.filter(e=>P(e.hours)).length,c=n.length-s;return`<p>Mostrando ${n.length} ${y.toLowerCase()} en total: ${s} abiertos, ${c} cerrados.</p>`;return}for([o,r]of Object.entries(C))if(e.includes(o)){if("negocios"===o||"negocio"===o||"comercios"===o||"comercio"===o||"abiertos"===o){const E={};x.forEach(e=>{E[e.category]||(E[e.category]=[]),E[e.category].push(e)});let a=0;for(var[l,d]of Object.entries(E)){d.some(e=>P(e.hours));0<d.length&&((i=document.createElement("div")).className="business-category-header",i.innerHTML=`
          <h5 style="margin: 16px 0 8px 0; color: #128C7E; font-size: 14px; font-weight: 600;">
            ${T(l)} ${l} (${d.length})
          </h5>
        `,k.appendChild(i),d.forEach(e=>{e=$(e,a++);k.appendChild(e)}))}var u=x.filter(e=>P(e.hours)).length,g=x.length-u;return`<p>Mostrando ${x.length} comercios en total: ${u} abiertos, ${g} cerrados.</p>`;return}if("soporte"===o||"whatsapp"===o||"wsp"===o)return"Para soporte inmediato, puedes contactarme por WhatsApp: [Contactar por WhatsApp](https://wa.me/5491157194796)";if("horarios"===o||"horario"===o){const w={};x.forEach(e=>{w[e.category]||(w[e.category]=[]),w[e.category].push(e)});let a=0;for(var[m,p]of Object.entries(w)){var f=document.createElement("div");f.className="business-category-header",f.innerHTML=`
        <h5 style="margin: 16px 0 8px 0; color: #128C7E; font-size: 14px; font-weight: 600;">
          ${T(m)} ${m}
        </h5>
      `,k.appendChild(f),p.forEach(e=>{e=$(e,a++);k.appendChild(e)})}return"<p>¿Te interesa saber el horario de algún comercio en particular?</p>";return}if("distancia"!==o)return"pagos"===o||"pago"===o||"tarjeta"===o||"efectivo"===o||"digital"===o?"Aceptamos efectivo, tarjetas de crédito y débito, transferencias bancarias y billeteras digitales como Mercado Pago.":r;{const L={};x.forEach(e=>{L[e.category]||(L[e.category]=[]),L[e.category].push(e)});let a=0;for(var[h,v]of Object.entries(L)){var b=document.createElement("div");b.className="business-category-header",b.innerHTML=`
        <h5 style="margin: 16px 0 8px 0; color: #128C7E; font-size: 14px; font-weight: 600;">
          ${T(h)} ${h}
        </h5>
      `,k.appendChild(b),v.forEach(e=>{e=$(e,a++);k.appendChild(e)})}return"<p>¿Te interesa la dirección de algún comercio en particular?</p>";return}}return"No entiendo tu pregunta. Puedo ayudarte con información sobre negocios, horarios, pagos, soporte, etc. ¿Puedes reformular tu pregunta?"}function f(){const a=i.value.trim();if(a){m(a,"user"),i.value="",i.style.height="auto";var e=document.createElement("div"),t=(e.className="typing-indicator",e.id="typingIndicator",document.createElement("div"));t.className="typing-dots";for(let e=0;e<3;e++){var o=document.createElement("div");o.className="typing-dot",t.appendChild(o)}e.appendChild(t),k.appendChild(e),k.scrollTop=k.scrollHeight,setTimeout(()=>{(e=document.getElementById("typingIndicator"))&&e.remove();var e=p(a);m(e,"bot")},1500)}}function h(e){i.value=e,f()}function v(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),f())}function b(){"webkitSpeechRecognition"in window||"SpeechRecognition"in window?g?y():c.classList.add("active"):m("Lo siento, tu navegador no soporta el reconocimiento de voz. Usa Chrome o Edge para esta función.","bot")}function y(){if(d)E();else try{var e=window.SpeechRecognition||window.webkitSpeechRecognition;(u=new e).continuous=!1,u.interimResults=!1,u.lang="es-ES",u.onresult=function(e){e=e.results[0][0].transcript;i.value=e,E(),f()},u.onerror=function(e){console.error("Error en el reconocimiento de voz:",e.error),"not-allowed"===e.error&&m("Permiso de micrófono denegado. Por favor, habilita el micrófono en la configuración de tu navegador.","bot"),E()},u.onend=function(){E()},u.start(),d=!0,s.classList.add("listening"),s.innerHTML='<i class="fas fa-stop"></i>'}catch(e){console.error("Error al iniciar el reconocimiento de voz:",e),m("Error al iniciar el micrófono. Por favor, verifica los permisos.","bot")}}function E(){u&&d&&u.stop(),d=!1,s.classList.remove("listening"),s.innerHTML='<i class="fas fa-microphone"></i>'}function w(){const t=document.createElement("div");t.className="quick-replies";[{text:"🏪 Negocios",action:"negocios"},{text:"🕒 Horarios",action:"horarios"},{text:"📍 Ubicación",action:"ubicación"},{text:"💬 Soporte",action:"soporte"}].forEach(e=>{var a=document.createElement("button");a.className="quick-reply",a.innerHTML=e.text,a.onclick=()=>h(e.action),t.appendChild(a)}),k.appendChild(t),k.scrollTop=k.scrollHeight}function L(){m("¡Hola! Soy tu asistente virtual. ¿En qué puedo ayudarte hoy?","bot"),setTimeout(w,1e3)}t&&t.addEventListener("click",function(){o.classList.add("active"),0===x.length&&a()}),r&&r.addEventListener("click",function(){o.classList.remove("active")}),n&&n.addEventListener("click",f),s&&s.addEventListener("click",b),i&&(i.addEventListener("keydown",v),i.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),e&&e.addEventListener("click",function(){navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){g=!0,c.classList.remove("active"),y()}).catch(function(e){console.error("Error al acceder al micrófono:",e),c.classList.remove("active"),m("No se pudo acceder al micrófono. Por favor, verifica los permisos en tu navegador.","bot")})}),l&&l.addEventListener("click",function(){c.classList.remove("active"),m("Puedes usar la función de texto para interactuar con el chatbot.","bot")}),c&&c.addEventListener("click",function(e){e.target===c&&c.classList.remove("active")}),document.addEventListener("click",function(e){window.innerWidth<=768&&(o.contains(e.target)||e.target===t||t.contains(e.target)||!o.classList.contains("active")||o.classList.remove("active"))}),window.addEventListener("resize",function(){window.innerWidth<=768?(o.style.bottom="80px",o.style.right="15px",o.style.left="15px"):(o.style.bottom="100px",o.style.right="30px",o.style.left="auto")}),window.chatbotInitAttempts=0,window.sendQuickReply=h,setTimeout(function e(){if(!window.chatbotInitialized){if(!document.getElementById("messageInput"))return window.chatbotInitAttempts<10?(window.chatbotInitAttempts++,void setTimeout(e,300)):void console.error("❌ Se alcanzó el límite de reintentos para messageInput. El chatbot funcionará con limitaciones.");window.chatbotInitAttempts=0,window.chatbotInitialized=!0,a(),n&&n.addEventListener("click",f),s&&s.addEventListener("click",b),i&&(i.addEventListener("keydown",v),i.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),r&&r.addEventListener("click",function(){o.classList.remove("active")}),setTimeout(L,500)}},500)});