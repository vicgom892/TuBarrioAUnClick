<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tu Barrio a un Clik - Comunidad</title>
  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Estilos personalizados -->
  <style>
    /* Reset y base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #fafafa;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* Gradientes */
    .bg-gradient-to-r {
      background: linear-gradient(90deg, #9c27b0, #e91e63);
    }

    .gradient-text {
      background: linear-gradient(45deg, #f09433, #e6683c, #dc277f, #c13584, #a9378f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: white;
      border-bottom: 1px solid #e6e6e6;
    }

    /* Logo */
    .logo-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #e1306c;
    }

    /* Historias Destacadas - Estilo Instagram */
    #historias {
      background: white;
      padding: 15px 0;
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
      border-bottom: 1px solid #e6e6e6;
    }
    
    #historias::-webkit-scrollbar {
      display: none;
    }
    
    .story-item {
      display: inline-block;
      margin: 0 10px;
      text-align: center;
      width: 66px;
    }
    
    .story-avatar {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      margin: 0 auto;
      padding: 2px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc277f, #c13584, #a9378f);
      position: relative;
    }
    
    .story-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      background: white;
    }
    
    .story-avatar.comercio {
      background: linear-gradient(45deg, #4CAF50, #2196F3);
    }
    
    .story-badge {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e6e6e6;
    }
    
    .story-badge i {
      font-size: 10px;
    }
    
    .story-name {
      font-size: 12px;
      color: #262626;
      margin-top: 5px;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 66px;
    }

    .story-name.comercio {
      color: #4CAF50;
      font-weight: 600;
    }

    /* Publicaciones */
    .post-card {
      background: white;
      border: 1px solid #e6e6e6;
      margin-bottom: 16px;
      border-radius: 0;
    }
    
    .post-header {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e6e6e6;
    }
    
    .post-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
      border: 1px solid #e6e6e6;
    }
    
    .post-user {
      font-weight: 600;
      font-size: 14px;
      color: #262626;
    }
    
    .post-user.comercio {
      color: #4CAF50;
    }
    
    .post-badge {
      margin-left: 5px;
      color: #4CAF50;
    }
    
    .post-time {
      font-size: 12px;
      color: #8e8e8e;
      margin-left: 5px;
    }

    .post-img {
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
    }

    .post-actions {
      padding: 12px;
      display: flex;
      gap: 16px;
    }
    
    .post-actions i {
      font-size: 24px;
    }
    
    .post-actions .far.fa-heart, .post-actions .far.fa-comment {
      color: #262626;
    }
    
    .post-actions .fas.fa-heart {
      color: #ed4956;
    }
    
    .post-actions .fas.fa-comment {
      color: #262626;
    }
    
    .post-actions .fas.fa-paper-plane {
      color: #262626;
    }

    .post-likes {
      padding: 0 12px;
      font-weight: 600;
      font-size: 14px;
      color: #262626;
    }

    .post-caption {
      padding: 0 12px;
      font-size: 14px;
      color: #262626;
    }
    
    .post-caption strong {
      font-weight: 600;
    }

    .post-comments {
      padding: 0 12px;
      font-size: 14px;
      color: #262626;
    }
    
    .comment {
      margin: 5px 0;
    }
    
    .comment strong {
      font-weight: 600;
    }

    .post-time-footer {
      padding: 0 12px;
      font-size: 12px;
      color: #8e8e8e;
      margin: 8px 0;
    }

    /* Barra de navegaci√≥n inferior fija */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: white;
      border-top: 1px solid #e6e6e6;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 20%;
      height: 100%;
      color: #8e8e8e;
      font-size: 12px;
       cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .nav-item i {
      font-size: 22px;
    }
    
    .nav-item.active {
      color: #262626;
    }
    
    .nav-item:hover {
      color: #262626;
    }

    /* Modal de Login mejorado */
    .login-modal-content {
      border-radius: 0;
      overflow: hidden;
    }
    
    .login-header {
      background: white;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #dbdbdb;
    }
    
    .login-body {
      padding: 20px;
    }
    
    .form-label {
      font-size: 12px;
      color: #8e8e8e;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .form-control {
      border: 1px solid #dbdbdb;
      border-radius: 4px;
      height: 36px;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .btn-login {
      background: #0095f6;
      color: white;
      border: none;
      border-radius: 4px;
      height: 36px;
      font-weight: 600;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .btn-login:disabled {
      background: #b2dffc;
      color: rgba(255,255,255,0.8);
    }
    
    .btn-outline-primary {
      border-color: #0095f6;
      color: #0095f6;
    }

    /* Tipo de usuario */
    .tipo-usuario {
      display: none;
      margin-top: 15px;
    }
    
    .tipo-usuario-header {
      font-size: 14px;
      color: #8e8e8e;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .tipo-usuario-options {
      display: flex;
      gap: 10px;
    }
    
    .tipo-usuario-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid #dbdbdb;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tipo-usuario-btn:hover {
      background: #f0f0f0;
    }
    
    .tipo-usuario-btn.active {
      border-color: #0095f6;
      background: #0095f6;
      color: white;
    }
    
    .tipo-usuario-icon {
      font-size: 20px;
      margin-bottom: 5px;
    }

    /* C√°mara en tiempo real */
    .camera-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    #videoStream {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .camera-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    
    .camera-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: white;
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }

    /* Vista previa de imagen */
    .preview-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 300px;
      margin: 10px 0;
    }

    /* Perfil de usuario */
    .user-profile {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border-bottom: 1px solid #e6e6e6;
    }
    
    .user-profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      border: 1px solid #e6e6e6;
    }
    
    .user-profile-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e6e6e6;
    }
    
    .user-profile-badge i {
      font-size: 10px;
      color: #4CAF50;
    }
    
    .user-profile-name {
      font-weight: 600;
      font-size: 16px;
      color: #262626;
    }

    .user-profile-name.comercio {
      color: #4CAF50;
    }

    /* Animaciones */
    @keyframes heartBeat {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    .heart-pulse {
      animation: heartBeat 0.6s ease;
    }

    /* Filtros */
    .filters-container {
      background: white;
      padding: 10px 0;
      border-bottom: 1px solid #e6e6e6;
    }

    /* Overlay para usuarios no autorizados */
    .overlay-no-autorizado {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
    }
    
    .overlay-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .overlay-content h3 {
      color: #e1306c;
      margin-bottom: 15px;
    }
    
    .overlay-content p {
      margin-bottom: 20px;
      color: #666;
    }
    
    .btn-overlay {
      background: #0095f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      margin: 0 5px;
    }

    /* Panel de administrador */
    .admin-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 9999;
      display: none;
      overflow-y: auto;
    }
    
    .admin-header {
      background: #e1306c;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    
    .user-card {
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem;
      background: white;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    
    .user-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e1306c;
    }
    
    .btn-aprobar {
      background: #0095f6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 2rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .form-control {
      margin-bottom: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 0;
      }
      
      .bottom-nav {
        height: 50px;
      }
      
      .nav-item i {
        font-size: 22px;
      }
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Overlay para usuarios no autorizados -->
  <div id="overlayNoAutorizado" class="overlay-no-autorizado">
    <div class="overlay-content">
      <h3><i class="fas fa-lock"></i> Acceso Restringido</h3>
      <p>Para poder publicar, comentar o dar "Me gusta", necesitas ser autorizado por el administrador.</p>
      <p>Por favor, completa el formulario de registro y espera la confirmaci√≥n.</p>
      <div>
        <button id="btnCerrarOverlay" class="btn-overlay">Cerrar</button>
        <button id="btnIrALogin" class="btn-overlay">Crear Cuenta</button>
      </div>
    </div>
  </div>

  <!-- Panel de Administrador -->
  <div id="adminPanel" class="admin-panel">
    <div class="admin-header">
      <h4><i class="fas fa-user-shield"></i> Panel de Administraci√≥n</h4>
      <p>Gestiona usuarios de la comunidad</p>
    </div>

    <div class="container mt-4">
      <h5>Usuarios Pendientes</h5>
      <div id="listaUsuarios"></div>
    </div>
  </div>

  <!-- Modal de Login -->
  <div id="loginModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content login-modal-content">
        <div class="login-header">
          <img src="img/icon-abeja-sola.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
          <h5 class="mb-0 mt-2">Comunidad Castelar</h5>
        </div>
        <div class="login-body">
          <p class="text-center text-muted mb-4">√önete a vecinos y comerciantes de Castelar</p>
          <form id="loginForm">
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombre" required>
            </div>
            <div class="mb-3">
              <label for="telefono" class="form-label">Tel√©fono (con c√≥digo)</label>
              <input type="tel" class="form-control" id="telefono" placeholder="+5491157194796" required>
            </div>
            <div class="mb-3">
              <label for="fotoPerfil" class="form-label">Foto de perfil</label>
              <input type="file" class="form-control" id="fotoPerfil" accept="image/*">
              <div id="previewPerfil" class="mt-2" style="display: none;">
                <img id="imgPerfil" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
              </div>
            </div>
            
            <div class="mb-3 tipo-usuario" id="tipoUsuario">
              <div class="tipo-usuario-header">¬øQu√© tipo de usuario eres?</div>
              <div class="tipo-usuario-options">
                <div class="tipo-usuario-btn" id="btnCliente">
                  <div class="tipo-usuario-icon">
                    <i class="fas fa-user"></i>
                  </div>
                  <div>Cliente</div>
                </div>
                <div class="tipo-usuario-btn" id="btnComercio">
                  <div class="tipo-usuario-icon">
                    <i class="fas fa-store"></i>
                  </div>
                  <div>Comercio</div>
                </div>
              </div>
            </div>

            <button type="submit" class="btn btn-login w-100" id="btnEnviar">
              <i class="fab fa-whatsapp me-2"></i> Validar por WhatsApp
            </button>
            
            <button type="button" class="btn btn-outline-primary w-100 mt-2" id="btnSeleccionarTipo">
              Quiero seleccionar mi tipo de usuario
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white shadow-sm border-b">
    <div class="container d-flex justify-content-between align-items-center py-3">
      <div class="d-flex align-items-center">
        <img src="img/icon-abeja-sola.png" alt="Logo" class="logo-img me-2" style="height: 40px;">
        <h2 class="h5 mb-0 text-dark">Comunidad</h2>
      </div>
      <button id="btnPublicar" class="btn btn-sm btn-outline-primary d-none">
        <i class="fas fa-plus me-1"></i> Publicar
      </button>
      <button id="btnSalir" class="btn btn-sm btn-outline-danger">
        <i class="fas fa-sign-out-alt"></i>
      </button>
      <!-- Bot√≥n de alertas en el header -->
      <button id="btnAlertas" class="btn btn-sm btn-outline-warning ms-2">
        <i class="fas fa-bullhorn"></i>
      </button>
    </div>
  </header>

  <!-- Perfil de usuario -->
  <div id="userProfile" class="user-profile d-none">
    <div style="position: relative;">
      <img id="userProfileImg" class="user-profile-img" src="" alt="Tu foto">
      <div id="userProfileBadge" class="user-profile-badge" style="display: none;">
        <i class="fas fa-store"></i>
      </div>
    </div>
    <div class="user-profile-name" id="userProfileName"></div>
  </div>

  <div id="userStats" class="d-flex justify-content-around bg-white py-2 border-bottom d-none">
    <div class="text-center">
      <div class="fw-bold">12</div>
      <div class="text-muted small">Publicaciones</div>
    </div>
    <div class="text-center">
      <div class="fw-bold">34</div>
      <div class="text-muted small">Seguidores</div>
    </div>
    <div class="text-center">
      <div class="fw-bold">28</div>
      <div class="text-muted small">Siguiendo</div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container container">
    <div class="btn-group w-100" role="group">
      <button id="filterTodos" class="btn btn-sm btn-primary flex-fill">Todos</button>
      <button id="filterClientes" class="btn btn-sm btn-outline-primary flex-fill">Vecinos</button>
      <button id="filterComercios" class="btn btn-sm btn-outline-primary flex-fill">Comercios</button>
    </div>
  </div>

  <!-- Historias Destacadas -->
  <section id="historias" class="container">
    <div id="storiesContainer">
      <!-- Historias se cargar√°n aqu√≠ -->
    </div>
  </section>

  <!-- Contenido principal -->
  <main class="container my-3">
    <!-- Muro de publicaciones -->
    <div id="muroComunidad" class="space-y-4">
      <!-- Publicaciones se cargar√°n aqu√≠ -->
    </div>
  </main>

  <!-- Modal de C√°mara en Tiempo Real -->
  <div id="modalCamara" class="modal-camera">
    <div class="camera-header">
      <h5>C√°mara</h5>
      <button id="cerrarCamara" class="btn-close btn-close-white"></button>
    </div>
    <div class="camera-container">
      <video id="videoStream" autoplay></video>
      <div class="camera-controls">
        <button id="capturarFoto" class="camera-btn">
          <i class="fas fa-circle"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Subida de Foto -->
  <div id="modalSubida" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Nueva Publicaci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div id="previewContainer" class="preview-container" style="display: none;">
            <img id="previewImagen" class="preview-image">
          </div>

          <div class="btn-group-vertical w-100 mb-3" role="group">
            <button id="btnCamara" class="btn btn-white text-start border d-flex align-items-center p-3">
              <i class="fas fa-camera me-3" style="color: #262626;"></i>
              <span style="color: #262626;">Tomar foto con c√°mara</span>
            </button>
            <button id="btnGaleria" class="btn btn-white text-start border d-flex align-items-center p-3 mt-2">
              <i class="fas fa-images me-3" style="color: #262626;"></i>
              <span style="color: #262626;">Desde galer√≠a</span>
            </button>
          </div>

          <textarea id="inputComentario" class="form-control mb-3" rows="3" placeholder="Agrega un comentario..."></textarea>

          <div class="d-flex gap-2">
            <button id="btnCancelar" class="btn btn-light flex-fill">
              Cancelar
            </button>
            <button id="btnCompartir" class="btn btn-primary flex-fill">
              Compartir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de Navegaci√≥n Inferior Fija -->
  <div class="bottom-nav">
    <div class="nav-item active" id="navHome">
      <i class="fas fa-home"></i>
      <span>Inicio</span>
    </div>
    <div class="nav-item" id="navSearch">
      <i class="fas fa-search"></i>
      <span>Buscar</span>
    </div>
    <div class="nav-item" id="navCamara">
      <i class="fas fa-plus-circle"></i>
      <span>Publicar</span>
    </div>
    <div class="nav-item" id="navHeart">
      <i class="far fa-heart"></i>
      <span>Favoritos</span>
    </div>
    <div class="nav-item" id="navProfile">
      <i class="far fa-user"></i>
      <span>Perfil</span>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t py-3 text-center text-sm text-gray-600">
    <div class="container">
      <p>üêù Hecho con amor para Castelar</p>
      <a href="index.html" class="text-purple-600">Volver al inicio</a>
    </div>
  </footer>

  <script>
    // Detectar si se puede instalar
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btnInstalar = document.createElement('button');
      btnInstalar.innerHTML = '<i class="fas fa-download"></i>';
      btnInstalar.className = 'btn btn-sm btn-outline-success ms-2';
      btnInstalar.onclick = () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
        });
      };
      document.querySelector('.container').appendChild(btnInstalar);
    });
  </script>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Estado de autorizaci√≥n del usuario
    let usuarioAutorizado = false;
    
    // Contrase√±a del admin (c√°mbiala despu√©s)
    const CONTRASENA_ADMIN = "admin123";

    // Datos de usuarios activos (simulaci√≥n)
    const usuariosActivos = [
      { nombre: "Panader√≠a Don Juan", imagen: "https://images.unsplash.com/photo-1512151612113-413646f75631?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: true, tipo: 'comercio' },
      { nombre: "Ana R.", imagen: "https://images.unsplash.com/photo-1494790108787-9a95c545c4c7?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: true, tipo: 'cliente' },
      { nombre: "Carlos M.", imagen: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: false, tipo: 'cliente' },
      { nombre: "Farmacia Central", imagen: "https://images.unsplash.com/photo-1581595219318-439090bc7293?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: true, tipo: 'comercio' },
      { nombre: "Luisa P.", imagen: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: true, tipo: 'cliente' },
      { nombre: "Kiosco Don Pepe", imagen: "https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80", activo: false, tipo: 'comercio' }
    ];
    
    // Base de datos simulada
    let publicaciones = JSON.parse(localStorage.getItem('comunidadPosts')) || [
      {
        id: 1,
        usuario: "Panader√≠a Don Juan",
        tipo: "comercio",
        foto: "https://images.unsplash.com/photo-1512151612113-413646f75631?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
        descripcion: "Hoy salieron calentitos! üßÅ #facturitos #dulceDeLeche",
        likes: 12,
        liked: false,
        comentarios: [
          { usuario: "Mar√≠a G.", texto: "Los amo! Siempre los compro los s√°bados." }
        ],
        timestamp: Date.now() - 3600000
      }
    ];

    // Verificar estado de autorizaci√≥n
    function verificarAutorizacion() {
      const estado = localStorage.getItem('usuarioAutorizado');
      if (estado === 'true') {
        usuarioAutorizado = true;
        document.getElementById('overlayNoAutorizado').style.display = 'none';
      } else {
        usuarioAutorizado = false;
        if (localStorage.getItem('usuarioValidado') === 'true') {
          document.getElementById('overlayNoAutorizado').style.display = 'flex';
        }
      }
    }

    // Guardar en localStorage
    function guardarPublicaciones() {
      localStorage.setItem('comunidadPosts', JSON.stringify(publicaciones));
    }

    // Formatear fecha
    function formatoFecha(timestamp) {
      const ahora = new Date();
      const pub = new Date(timestamp);
      const diff = ahora - pub;
      const minutos = Math.floor(diff / 60000);
      if (minutos < 1) return "Ahora";
      if (minutos < 60) return `Hace ${minutos}m`;
      const horas = Math.floor(minutos / 60);
      if (horas < 24) return `Hace ${horas}h`;
      return pub.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
    }

    // Renderizar historias
    function renderizarHistorias() {
      const contenedor = document.getElementById('storiesContainer');
      contenedor.innerHTML = '';

      
      const tuHistoria = document.createElement('div');
      tuHistoria.className = 'story-item';
      tuHistoria.innerHTML = `
        <div class="story-avatar ${localStorage.getItem('usuarioTipo') === 'comercio' ? 'comercio' : ''}">
          <img src="${localStorage.getItem('usuarioFoto') || 'https://ui-avatars.com/api/?name=' + (localStorage.getItem('usuarioNombre') || 'Usuario') + '&background=random'}" alt="Tu foto">
          ${localStorage.getItem('usuarioTipo') === 'comercio' ? '<div class="story-badge"><i class="fas fa-store"></i></div>' : ''}
        </div>
        <div class="story-name ${localStorage.getItem('usuarioTipo') === 'comercio' ? 'comercio' : ''}">Tu historia</div>
      `;
      contenedor.appendChild(tuHistoria);

      
      usuariosActivos.forEach(usuario => {
        const historia = document.createElement('div');
        historia.className = 'story-item';
        historia.innerHTML = `
          <div class="story-avatar ${usuario.tipo === 'comercio' ? 'comercio' : ''}">
            <img src="${usuario.imagen}" alt="${usuario.nombre}">
            ${usuario.activo ? '<div class="story-badge"><i class="fas fa-circle" style="color: #26c43b; font-size: 8px;"></i></div>' : ''}
          </div>
          <div class="story-name ${usuario.tipo === 'comercio' ? 'comercio' : ''}">${usuario.nombre}</div>
        `;
        contenedor.appendChild(historia);
      });
    }

    // Renderizar muro
    function renderizarMuro(filtro = 'todos') {
      const contenedor = document.getElementById('muroComunidad');
      contenedor.innerHTML = '';


      let pubsFiltradas = publicaciones;
      if (filtro === 'clientes') {
        pubsFiltradas = publicaciones.filter(p => p.tipo === 'cliente');
      } else if (filtro === 'comercios') {
        pubsFiltradas = publicaciones.filter(p => p.tipo === 'comercio');
      }

      pubsFiltradas.sort((a, b) => b.timestamp - a.timestamp).forEach(pub => {
        const pubEl = document.createElement('div');
        pubEl.className = 'post-card';

        pubEl.innerHTML = `
          <div class="post-header">
            <img src="${pub.usuario === localStorage.getItem('usuarioNombre') ? localStorage.getItem('usuarioFoto') || 'https://ui-avatars.com/api/?name=' + pub.usuario + '&background=random' : 'https://ui-avatars.com/api/?name=' + pub.usuario + '&background=random'}" class="post-avatar" alt="${pub.usuario}">
            <div>
              <div class="post-user ${pub.tipo === 'comercio' ? 'comercio' : ''}">
                ${pub.usuario}
                ${pub.tipo === 'comercio' ? '<i class="fas fa-store post-badge"></i>' : ''}
              </div>
              <span class="post-time">${formatoFecha(pub.timestamp)}</span>
            </div>
          </div>
          <img src="${pub.foto}" class="post-img">
          <div class="post-actions">
            <button class="btn-like ${usuarioAutorizado ? '' : 'requiere-autorizacion'}" data-id="${pub.id}">
              <i class="far fa-heart ${pub.liked ? 'fas text-danger' : ''}"></i>
            </button>
            <button class="btn-comentar ${usuarioAutorizado ? '' : 'requiere-autorizacion'}" data-id="${pub.id}">
              <i class="far fa-comment"></i>
            </button>
            <button class="btn-compartir" data-id="${pub.id}">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="post-likes">${pub.likes} me gusta</div>
          <div class="post-caption">
            <strong>${pub.usuario} ${pub.tipo === 'comercio' ? '<i class="fas fa-store" style="color: #4CAF50;"></i>' : ''}</strong> ${pub.descripcion}
          </div>
          <div class="post-comments">
            ${pub.comentarios.map(c => `<div class="comment"><strong>${c.usuario}:</strong> ${c.texto}</div>`).join('')}
          </div>
          <div class="post-time-footer">${formatoFecha(pub.timestamp)}</div>
        `;

        contenedor.appendChild(pubEl);
      });

      agregarEventosInteraccion();
    }

    // Eventos de interacci√≥n
    function agregarEventosInteraccion() {

      document.querySelectorAll('.btn-like').forEach(btn => {
        btn.addEventListener('click', function(e) {
          if (!usuarioAutorizado) {
            e.preventDefault();
            document.getElementById('overlayNoAutorizado').style.display = 'flex';
            return;
          }
          
          const id = this.getAttribute('data-id');
          const pub = publicaciones.find(p => p.id == id);
          
          if (!pub.liked) {
            pub.likes += 1;
            pub.liked = true;
            this.querySelector('i').classList.replace('far', 'fas');
            this.querySelector('i').classList.add('text-danger');
            this.querySelector('i').classList.add('heart-pulse');
            setTimeout(() => {
              this.querySelector('i').classList.remove('heart-pulse');
            }, 600);
          } else {
            pub.likes -= 1;
            pub.liked = false;
            this.querySelector('i').classList.replace('fas', 'far');
            this.querySelector('i').classList.remove('text-danger');
          }
          
          guardarPublicaciones();
          renderizarMuro();
        });
      });

      
      document.querySelectorAll('.btn-comentar').forEach(btn => {
        btn.addEventListener('click', function(e) {
          if (!usuarioAutorizado) {
            e.preventDefault();
            document.getElementById('overlayNoAutorizado').style.display = 'flex';
            return;
          }
          
          const id = this.getAttribute('data-id');
          const pub = publicaciones.find(p => p.id == id);
          
          const comentario = prompt(`Comentar en la publicaci√≥n de ${pub.usuario}:`);
          if (comentario && comentario.trim()) {
            const usuario = localStorage.getItem('usuarioNombre') || 'Vecino';
            pub.comentarios.push({
              usuario: usuario,
              texto: comentario.trim()
            });
            
            guardarPublicaciones();
            renderizarMuro();
          }
        });
      });
    }

    // Variables para c√°mara
    let stream = null;
    let imagenDataURL = null;
    const modalCamara = document.getElementById('modalCamara');
    const videoStream = document.getElementById('videoStream');
    const modalSubida = new bootstrap.Modal(document.getElementById('modalSubida'));

    
    document.getElementById('navCamara').addEventListener('click', function() {
      if (!usuarioAutorizado) {
        document.getElementById('overlayNoAutorizado').style.display = 'flex';
        return;
      }
      
      abrirCamara();
    });
    
    function abrirCamara() {
      try {
        navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' },
          audio: false 
        }).then(function(mediaStream) {
          stream = mediaStream;
          videoStream.srcObject = stream;
          modalCamara.style.display = 'flex';
        }).catch(function(err) {
          alert('No se pudo acceder a la c√°mara: ' + err.message);
          console.error('Error al acceder a la c√°mara:', err);
        });
      } catch (err) {
        alert('No se pudo acceder a la c√°mara: ' + err.message);
        console.error('Error al acceder a la c√°mara:', err);
      }
    }

    document.getElementById('cerrarCamara').addEventListener('click', function() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      modalCamara.style.display = 'none';
    });

    document.getElementById('capturarFoto').addEventListener('click', function() {
      if (!usuarioAutorizado) {
        document.getElementById('overlayNoAutorizado').style.display = 'flex';
        return;
      }
      
      const canvas = document.createElement('canvas');
      canvas.width = videoStream.videoWidth;
      canvas.height = videoStream.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoStream, 0, 0, canvas.width, canvas.height);
      
      imagenDataURL = canvas.toDataURL('image/jpeg');
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      modalCamara.style.display = 'none';
      
      const previewImagen = document.getElementById('previewImagen');
      const previewContainer = document.getElementById('previewContainer');
      previewImagen.src = imagenDataURL;
      previewContainer.style.display = 'block';
      
      modalSubida.show();
    });

    document.getElementById('btnGaleria').addEventListener('click', function() {
      if (!usuarioAutorizado) {
        document.getElementById('overlayNoAutorizado').style.display = 'flex';
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            imagenDataURL = e.target.result;
            const previewImagen = document.getElementById('previewImagen');
            const previewContainer = document.getElementById('previewContainer');
            previewImagen.src = imagenDataURL;
            previewContainer.style.display = 'block';
            modalSubida.show();
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    });

    document.getElementById('btnCompartir').addEventListener('click', function() {
      if (!usuarioAutorizado) {
        document.getElementById('overlayNoAutorizado').style.display = 'flex';
        return;
      }
      
      if (!imagenDataURL) {
        alert('Por favor, selecciona una foto.');
        return;
      }

      const usuario = localStorage.getItem('usuarioNombre') || 'Vecino de Castelar';
      const tipo = localStorage.getItem('usuarioTipo') || 'cliente';
      const comentario = document.getElementById('inputComentario').value.trim();

      const nuevaPub = {
        id: Date.now(),
        usuario: usuario,
        tipo: tipo,
        descripcion: comentario,
        foto: imagenDataURL,
        likes: 0,
        liked: false,
        comentarios: [],
        timestamp: Date.now()
      };

      publicaciones.unshift(nuevaPub);
      guardarPublicaciones();
      renderizarMuro();

      modalSubida.hide();
      imagenDataURL = null;
    });

    document.getElementById('btnCancelar').addEventListener('click', function() {
      modalSubida.hide();
      imagenDataURL = null;
    });

    document.getElementById('navHome').addEventListener('click', function() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      this.classList.add('active');
      renderizarMuro();
    });

    document.getElementById('navHeart').addEventListener('click', function() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      this.classList.add('active');
      
      const favoritos = publicaciones.filter(pub => pub.liked);
      if (favoritos.length === 0) {
        alert('No tienes publicaciones favoritas a√∫n. Dale "Me gusta" a las publicaciones que te gusten.');
        document.getElementById('navHome').click();
        return;
      }
      
      const contenedor = document.getElementById('muroComunidad');
      contenedor.innerHTML = '';
      
      favoritos.sort((a, b) => b.timestamp - a.timestamp).forEach(pub => {
        const pubEl = document.createElement('div');
        pubEl.className = 'post-card';

        pubEl.innerHTML = `
          <div class="post-header">
            <img src="${pub.usuario === localStorage.getItem('usuarioNombre') ? localStorage.getItem('usuarioFoto') || 'https://ui-avatars.com/api/?name=' + pub.usuario + '&background=random' : 'https://ui-avatars.com/api/?name=' + pub.usuario + '&background=random'}" class="post-avatar" alt="${pub.usuario}">
            <div>
              <div class="post-user ${pub.tipo === 'comercio' ? 'comercio' : ''}">
                ${pub.usuario}
                ${pub.tipo === 'comercio' ? '<i class="fas fa-store post-badge"></i>' : ''}
              </div>
              <span class="post-time">${formatoFecha(pub.timestamp)}</span>
            </div>
          </div>
          <img src="${pub.foto}" class="post-img">
          <div class="post-actions">
            <button class="btn-like" data-id="${pub.id}">
              <i class="fas fa-heart text-danger"></i>
            </button>
            <button class="btn-comentar" data-id="${pub.id}">
              <i class="far fa-comment"></i>
            </button>
            <button class="btn-compartir" data-id="${pub.id}">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="post-likes">${pub.likes} me gusta</div>
          <div class="post-caption">
            <strong>${pub.usuario} ${pub.tipo === 'comercio' ? '<i class="fas fa-store" style="color: #4CAF50;"></i>' : ''}</strong> ${pub.descripcion}
          </div>
          <div class="post-comments">
            ${pub.comentarios.map(c => `<div class="comment"><strong>${c.usuario}:</strong> ${c.texto}</div>`).join('')}
          </div>
          <div class="post-time-footer">${formatoFecha(pub.timestamp)}</div>
        `;

        contenedor.appendChild(pubEl);
      });

      agregarEventosInteraccion();
    });

    // Manejo de tipo de usuario en login
    document.getElementById('btnSeleccionarTipo').addEventListener('click', function() {
      document.getElementById('tipoUsuario').style.display = 'block';
      this.style.display = 'none';
    });

    document.getElementById('btnCliente').addEventListener('click', function() {
      document.querySelectorAll('.tipo-usuario-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      this.classList.add('active');
      localStorage.setItem('tempTipoUsuario', 'cliente');
    });

    document.getElementById('btnComercio').addEventListener('click', function() {
      document.querySelectorAll('.tipo-usuario-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      this.classList.add('active');
      localStorage.setItem('tempTipoUsuario', 'comercio');
    });

    // Login
    document.getElementById('loginForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const fotoInput = document.getElementById('fotoPerfil');

      if (!nombre || !telefono) return;

      let fotoPerfil = null;
      let tipoUsuario = localStorage.getItem('tempTipoUsuario') || 'cliente';

      if (fotoInput.files && fotoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          fotoPerfil = e.target.result;
          procesarLogin(nombre, telefono, fotoPerfil, tipoUsuario);
        };
        reader.readAsDataURL(fotoInput.files[0]);
      } else {
        fotoPerfil = 'https://ui-avatars.com/api/?name=' + nombre + '&background=random';
        procesarLogin(nombre, telefono, fotoPerfil, tipoUsuario);
      }
    });

    function procesarLogin(nombre, telefono, fotoPerfil, tipoUsuario) {
      const texto = `*üîî NUEVA SOLICITUD DE COMUNIDAD*\n\n*Nombre:* ${nombre}\n*Tel√©fono:* ${telefono}\n*Tipo:* ${tipoUsuario === 'comercio' ? 'Comercio' : 'Cliente'}`;
      const numeroWhatsApp = '5491157194796';
      const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(texto)}`;

      window.open(url, '_blank');

      // Guardar en lista global de usuarios
      const usuarios = JSON.parse(localStorage.getItem('usuariosRegistrados') || '[]');
      const existe = usuarios.find(u => u.telefono === telefono);
      if (!existe) {
        usuarios.push({
          nombre,
          telefono,
          tipo: tipoUsuario,
          foto: fotoPerfil,
          autorizado: false,
          timestamp: Date.now()
        });
        localStorage.setItem('usuariosRegistrados', JSON.stringify(usuarios));
      }

      localStorage.setItem('usuarioValidado', 'true');
      localStorage.setItem('usuarioNombre', nombre);
      localStorage.setItem('usuarioFoto', fotoPerfil);
      localStorage.setItem('usuarioTipo', tipoUsuario);
      localStorage.setItem('usuarioTelefono', telefono);
      localStorage.setItem('usuarioAutorizado', 'false');
      location.reload();
    }

    // Salir
    document.getElementById('btnSalir')?.addEventListener('click', function() {
      localStorage.removeItem('usuarioValidado');
      localStorage.removeItem('usuarioNombre');
      localStorage.removeItem('usuarioFoto');
      localStorage.removeItem('usuarioTipo');
      localStorage.removeItem('usuarioTelefono');
      localStorage.removeItem('usuarioAutorizado');
      localStorage.removeItem('tempTipoUsuario');
      location.href = 'index.html';
    });

    // Filtros
    document.getElementById('filterTodos').addEventListener('click', function() {
      document.querySelectorAll('.btn-sm').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      });
      this.classList.remove('btn-outline-primary');
      this.classList.add('btn-primary');
      renderizarMuro('todos');
    });

    document.getElementById('filterClientes').addEventListener('click', function() {
      document.querySelectorAll('.btn-sm').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      });
      this.classList.remove('btn-outline-primary');
      this.classList.add('btn-primary');
      renderizarMuro('clientes');
    });

    document.getElementById('filterComercios').addEventListener('click', function() {
      document.querySelectorAll('.btn-sm').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      });
      this.classList.remove('btn-outline-primary');
      this.classList.add('btn-primary');
      renderizarMuro('comercios');
    });

    // Alertas - Acceso al panel de admin
    document.getElementById('btnAlertas').addEventListener('click', function() {
      const pass = prompt('üîê Ingresa la contrase√±a de administrador:');
      if (pass === CONTRASENA_ADMIN) {
        mostrarPanelAdmin();
      } else if (pass !== null) {
        alert('Contrase√±a incorrecta');
      }
    });

    // Cerrar overlay
    document.getElementById('btnCerrarOverlay').addEventListener('click', function() {
      document.getElementById('overlayNoAutorizado').style.display = 'none';
    });

    document.getElementById('btnIrALogin').addEventListener('click', function() {
      document.getElementById('overlayNoAutorizado').style.display = 'none';
      const modalLogin = new bootstrap.Modal(document.getElementById('loginModal'));
      modalLogin.show();
    });

    // Panel de Administrador
    function mostrarPanelAdmin() {
      document.getElementById('adminPanel').style.display = 'block';
      cargarUsuariosPendientes();
    }

    function cargarUsuariosPendientes() {
      const lista = document.getElementById('listaUsuarios');
      lista.innerHTML = '';

      const usuarios = JSON.parse(localStorage.getItem('usuariosRegistrados') || '[]');
      const pendientes = usuarios.filter(u => u.autorizado !== true);

      if (pendientes.length === 0) {
        lista.innerHTML = '<p class="text-muted">No hay usuarios pendientes de aprobaci√≥n.</p>';
        return;
      }

      pendientes.forEach(usuario => {
        const div = document.createElement('div');
        div.className = 'user-card';
        div.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <img src="${usuario.foto || 'https://ui-avatars.com/api/?name=' + usuario.nombre + '&background=random'}" 
                   alt="Foto" class="user-photo me-3">
              <div>
                <strong>${usuario.nombre}</strong><br>
                <small>${usuario.telefono} ‚Ä¢ ${usuario.tipo}</small>
              </div>
            </div>
            <button class="btn-aprobar" onclick="aprobarUsuario('${usuario.telefono}')">
              Aprobar
            </button>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    function aprobarUsuario(telefono) {
      const usuarios = JSON.parse(localStorage.getItem('usuariosRegistrados') || '[]');
      const usuario = usuarios.find(u => u.telefono === telefono);
      
      if (usuario) {
        usuario.autorizado = true;
        localStorage.setItem('usuariosRegistrados', JSON.stringify(usuarios));
        
        // Si es el usuario actual, activarlo
        if (localStorage.getItem('usuarioTelefono') === telefono) {
          localStorage.setItem('usuarioAutorizado', 'true');
          location.reload();
        }
        
        alert(`Usuario ${usuario.nombre} aprobado correctamente.`);
        cargarUsuariosPendientes();
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      const usuarioValidado = localStorage.getItem('usuarioValidado') === 'true';
      const modalLogin = new bootstrap.Modal(document.getElementById('loginModal'));

      verificarAutorizacion();

      if (!usuarioValidado) {
        // El usuario puede navegar pero no interactuar
      } else {
        document.getElementById('btnPublicar')?.classList.remove('d-none');
        
        const userProfile = document.getElementById('userProfile');
        const userProfileImg = document.getElementById('userProfileImg');
        const userProfileName = document.getElementById('userProfileName');
        const userProfileBadge = document.getElementById('userProfileBadge');
        
        userProfileImg.src = localStorage.getItem('usuarioFoto') || 'https://ui-avatars.com/api/?name=' + localStorage.getItem('usuarioNombre') + '&background=random';
        userProfileName.textContent = localStorage.getItem('usuarioNombre');
        
        if (localStorage.getItem('usuarioTipo') === 'comercio') {
          userProfileName.classList.add('comercio');
          userProfileBadge.style.display = 'block';
        }
        
        userProfile.classList.remove('d-none');
        document.getElementById('userStats').classList.remove('d-none');
      }

      renderizarHistorias();
      renderizarMuro();

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById('navHome').classList.add('active');

      document.getElementById('fotoPerfil')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const previewPerfil = document.getElementById('previewPerfil');
            const imgPerfil = document.getElementById('imgPerfil');
            imgPerfil.src = e.target.result;
            previewPerfil.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js');
      }
    });
  </script>
</body>
</html>